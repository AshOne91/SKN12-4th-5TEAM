# Medical AI Chatbot Platform
**(FastAPI ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê¸°ë°˜ ì˜ë£Œ ìƒë‹´ ì‹œìŠ¤í…œ)**

**NAME** : ê¶Œì„±í˜¸  
**TEL** : 010-8874-6452  
**PART** : PROGRAMMING  

**TEAM**: ìœˆë„ìš°ì¦ˆ (5ëª…)  
**MEMBERS**: ê¶Œì„±í˜¸, ë‚¨ì˜í—Œ, ì†í˜„ì„±, ì´ì¤€ë°°, ì´ì¤€ì„  
**ROLE**: ë°±ì—”ë“œ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° êµ¬í˜„  
**PERIOD**: 2024ë…„ (SKN 4ì°¨ í”„ë¡œì íŠ¸)

---

## â— ëª© ì°¨ â—

**â… . í”„ë¡œì íŠ¸ ê°œìš”**
1. Medical AI Chatbot Platform
2. í”„ë¡œì íŠ¸ ì§„í™” ê³¼ì • (ëª¨ë†€ë¦¬ì‹ â†’ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤)
3. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë° ê¸°ìˆ  ìŠ¤íƒ
4. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì„±

**â…¡. ê¸°ìˆ  êµ¬í˜„ ë° ì•„í‚¤í…ì²˜**
1. Template Method Pattern êµ¬í˜„
2. ê³ ê¸‰ ë²¡í„° ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
3. ì„ë² ë”© ëª¨ë¸ ë° ì „ì²˜ë¦¬ ì‹œìŠ¤í…œ
4. LangChain ê³ ê¸‰ í™œìš© êµ¬í˜„
5. ì¹´í…Œê³ ë¦¬ë³„ LLM ë¼ìš°íŒ… ì‹œìŠ¤í…œ

**â…¢. ì•„í‚¤í…ì²˜ ì„¤ê³„ ì² í•™ ë° ëª¨ë“ˆí™” ì „ëµ**
1. 3ê³„ì¸µ ì•„í‚¤í…ì²˜ ì„¤ê³„ ëª©ì 
2. ì‹œìŠ¤í…œ êµ¬ì„±ë„

**â…£. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„**
1. React ê¸°ë°˜ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤
2. íŒ€ í˜‘ì—… ìµœì í™” ì„±ê³¼

**â…¤. ë³„ì²¨ - í•µì‹¬ ì½”ë“œ êµ¬í˜„**
1. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì½”ë“œ
2. UUID ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œ
3. Template Method Pattern êµ¬í˜„
4. LangChain í†µí•© RAG ì‹œìŠ¤í…œ
5. Redis ì±„íŒ… íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ
6. ë°ì´í„°ë² ì´ìŠ¤ ë° ìºì‹œ ì‹œìŠ¤í…œ

---

## â… . í”„ë¡œì íŠ¸ ê°œìš”

### 1. Medical AI Chatbot Platform

| í•­ëª© | ë‚´ìš© |
|------|------|
| **í”„ë¡œì íŠ¸ëª…** | Medical AI Chatbot Platform |
| **í”Œë«í¼** | Web Application (React + FastAPI) |
| **í•µì‹¬ ê¸°ëŠ¥** | 1. ì˜ë£Œ ì •ë³´ AI ì±—ë´‡ ì„œë¹„ìŠ¤ |
| | 2. 6ê°œ ë„ë©”ì¸ë³„ ì „ë¬¸ ì„œë¹„ìŠ¤ (ì±—ë´‡, ì¹´í…Œê³ ë¦¬, ë³‘ì›ì •ë³´, ì•½ë¬¼ì •ë³´, ì‘ê¸‰ì§€ì›, ë‚´ì™¸ê³¼) |
| | 3. ì‹¤ì‹œê°„ ëŒ€í™”í˜• ì¸í„°í˜ì´ìŠ¤ |
| | 4. UUID ê¸°ë°˜ Access Token ì¸ì¦ ë° Redis ì„¸ì…˜ ê´€ë¦¬ |
| | 5. Template Method Pattern ê¸°ë°˜ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡° |
| **ê°œë°œí™˜ê²½** | Backend: Python 3.10+, FastAPI 0.115.13, uvicorn |
| | Database: MySQL, Firestore, Redis |
| | Frontend: React 19.1.0, JavaScript |
| | AI/ML: OpenAI gpt-4o-mini, FAISS 1.11.0, Sentence Transformers 4.1.0 |
| | LLM Framework: LangChain Core 0.3.66, LangChain OpenAI 0.3.25 |
| | Deployment: AWS EC2, Nginx |
| **ê°œë°œì¸ì›** | 5ëª… (íŒ€ í”„ë¡œì íŠ¸) |
| **ë‹´ë‹¹ì—­í• ** | **ë°±ì—”ë“œ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° êµ¬í˜„ ë¦¬ë“œ** |
| | - FastAPI ê¸°ë°˜ 6ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ì„¤ê³„ |
| | - Template Method Pattern ì ìš©í•œ í™•ì¥ ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ êµ¬í˜„ |
| | - LangChainì„ í™œìš©í•œ LLM í†µí•© íŒŒì´í”„ë¼ì¸ ê°œë°œ |
| | - MySQL/Firestore/Redis ë©€í‹° ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ |

**ğŸ“¸ [ìŠ¤í¬ë¦°ìƒ· ìœ„ì¹˜ A] - React UI ë©”ì¸ í™”ë©´**
```
ì—¬ê¸°ì— React ëŒ€ì‹œë³´ë“œ ë©”ì¸ í™”ë©´ ìŠ¤í¬ë¦°ìƒ· ì‚½ì…
- ì‹¤í–‰: cd frontend && npm start
- ë‚´ìš©: ì±—ë´‡ ì¸í„°í˜ì´ìŠ¤, 6ê°œ ë„ë©”ì¸ ì„ íƒ UI
```

**ğŸ¯ í”„ë¡œì íŠ¸ ëª©í‘œ**
ì˜ë£Œ ì ‘ê·¼ì„± ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ AI ê¸°ë°˜ ì˜ë£Œ ìƒë‹´ í”Œë«í¼ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. 
6ê°œ ì „ë¬¸ ë„ë©”ì¸(ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜, ì±—ë´‡, ë³‘ì›ì •ë³´, ì•½ë¬¼ì •ë³´, ì‘ê¸‰ì§€ì›, ë‚´ì™¸ê³¼)ìœ¼ë¡œ êµ¬ë¶„ëœ 
ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì¡°ë¡œ ê° ì˜ì—­ë³„ íŠ¹í™”ëœ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ğŸ“¸ [ìŠ¤í¬ë¦°ìƒ· ìœ„ì¹˜ B] - ì‹¤ì œ ì±—ë´‡ ëŒ€í™” í™”ë©´**
```
ì—¬ê¸°ì— ì‹¤ì œ ì§ˆë¬¸-ë‹µë³€ í”Œë¡œìš° ìŠ¤í¬ë¦°ìƒ· ì‚½ì…
- ì˜ˆì‹œ: "ì‹¬ì¥ ìˆ˜ìˆ  í›„ ì£¼ì˜ì‚¬í•­" ì§ˆë¬¸ê³¼ AI ë‹µë³€
- FastAPI Swagger ë¬¸ì„œ í™”ë©´ (6ê°œ ì„œë²„ë³„)
```

**ğŸ“Š [ì¸í¬ê·¸ë˜í”½ ìœ„ì¹˜ C] - í”„ë¡œì íŠ¸ ì„±ê³¼ ì§€í‘œ**
```
ì—¬ê¸°ì— ì„±ê³¼ ì§€í‘œ ì´ë¯¸ì§€ ì‚½ì…
- ì‘ë‹µì†ë„: í‰ê·  4.8ì´ˆ
- 6ê°œ ë„ë©”ì¸ ì²˜ë¦¬ëŸ‰
- ë™ì‹œ ì‚¬ìš©ì ì§€ì› ìˆ˜
```

**ğŸš€ GitHub Repository**: [https://github.com/SKN12-4th-5TEAM](https://github.com/SKN12-4th-5TEAM)

---

### 2. í”„ë¡œì íŠ¸ ì§„í™” ê³¼ì • (ëª¨ë†€ë¦¬ì‹ â†’ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤)

**2.1 1ì°¨ êµ¬í˜„ (3ì°¨ í”„ë¡œì íŠ¸ - ëª¨ë†€ë¦¬ì‹ ì•„í‚¤í…ì²˜)**

| í•­ëª© | êµ¬í˜„ ë‚´ìš© |
|------|----------|
| **ì•„í‚¤í…ì²˜** | Streamlit ê¸°ë°˜ ë‹¨ì¼ ì• í”Œë¦¬ì¼€ì´ì…˜ (app.py) |
| **UI í”„ë ˆì„ì›Œí¬** | Streamlit Web Interface |
| **ì„¸ì…˜ ê´€ë¦¬** | InMemoryChatMessageHistoryë¥¼ í†µí•œ ë¡œì»¬ ë©”ëª¨ë¦¬ ê´€ë¦¬ |
| **ëŒ€í™” ê¸°ëŠ¥** | - ì„¸ì…˜ ID ê¸°ë°˜ ë©€í‹° ì„¸ì…˜ ì§€ì›<br>- ì‹¤ì‹œê°„ ëŒ€í™” íˆìŠ¤í† ë¦¬ í‘œì‹œ<br>- ë‹µë³€ ìƒì„± ì¤‘ ìŠ¤í”¼ë„ˆ í‘œì‹œ |
| **ë¶€ê°€ ê¸°ëŠ¥** | - ëŒ€í™” ìš”ì•½ ê¸°ëŠ¥ (summarize_history í•¨ìˆ˜)<br>- íˆìŠ¤í† ë¦¬ ë‹¤ìš´ë¡œë“œ (chat_{session_id}.txt)<br>- ì„¸ì…˜ë³„ ë…ë¦½ ëŒ€í™” ê´€ë¦¬ |
| **í”„ë¡œì íŠ¸ êµ¬ì¡°** | ë‹¨ì¼ ë ˆë²¨ ëª¨ë“ˆ êµ¬ì¡° (chatbot/, llm/, rag/, preprocessing/) |

**2.2 2ì°¨ êµ¬í˜„ (4ì°¨ í”„ë¡œì íŠ¸ - ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜)**

| í•­ëª© | êµ¬í˜„ ë‚´ìš© |
|------|----------|
| **ì•„í‚¤í…ì²˜** | 6ê°œ ë…ë¦½ FastAPI ì„œë²„ë¡œ ë¶„í•´ |
| **ë””ìì¸ íŒ¨í„´** | Template Method Pattern ì ìš© |
| **ì„¸ì…˜ ê´€ë¦¬** | Redis ê¸°ë°˜ ë¶„ì‚° ì„¸ì…˜ ê´€ë¦¬ë¡œ ì „í™˜ |
| **í™•ì¥ì„±** | ì„œë¹„ìŠ¤ë³„ ë…ë¦½ ë°°í¬ ë° ìŠ¤ì¼€ì¼ë§ ê°€ëŠ¥ |
| **í”„ë¡œì íŠ¸ êµ¬ì¡°** | ê³„ì¸µì  êµ¬ì¡° (application/, template/, service/) |

**2.3 ê¸°ìˆ ì  ì§„í™”ì˜ í•µì‹¬ ìš”ì†Œ**

```python
# 3ì°¨ í”„ë¡œì íŠ¸: ì¸ë©”ëª¨ë¦¬ ì„¸ì…˜ ê´€ë¦¬
def get_session_history(session_id: str):
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

# 4ì°¨ í”„ë¡œì íŠ¸: Redis ë¶„ì‚° ì„¸ì…˜ ê´€ë¦¬  
async def save_chat_history(user_id: str, room_id: str, message: dict):
    key = f"chat_history:{user_id}:{room_id}"
    await r.rpush(key, json.dumps(message))
    await r.ltrim(key, -50, -1)  # ìµœê·¼ 50ê°œë§Œ ìœ ì§€
```

**ğŸ“¸ [ìŠ¤í¬ë¦°ìƒ· ìœ„ì¹˜ D] - 3ì°¨ vs 4ì°¨ UI ë¹„êµ**
```
ì—¬ê¸°ì— UI ì§„í™” ë¹„êµ ìŠ¤í¬ë¦°ìƒ· ì‚½ì…
[ì™¼ìª½] 3ì°¨: Streamlit ë‹¨ì¼ í˜ì´ì§€ UI
[ì˜¤ë¥¸ìª½] 4ì°¨: React SPA ëŒ€ì‹œë³´ë“œ
```

**ğŸ¯ ì§„í™”ì˜ ì„±ê³¼**
- **í™•ì¥ì„±**: ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ â†’ ë¶„ì‚° ë‹¤ì¤‘ í”„ë¡œì„¸ìŠ¤
- **ìœ ì§€ë³´ìˆ˜ì„±**: ëª¨ë†€ë¦¬ì‹ â†’ ë„ë©”ì¸ë³„ ë…ë¦½ ì„œë¹„ìŠ¤
- **ì„¸ì…˜ ê´€ë¦¬**: ë¡œì»¬ ë©”ëª¨ë¦¬ â†’ Redis í´ëŸ¬ìŠ¤í„° ì§€ì›

**ğŸ“Š [ë‹¤ì´ì–´ê·¸ë¨ ìœ„ì¹˜ E] - Package Diagram (íŒ¨í‚¤ì§€ ë‹¤ì´ì–´ê·¸ë¨) - ì•„í‚¤í…ì²˜ ì§„í™”**
```
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: UML Package Diagram (Before/After ë¹„êµ)
ì—¬ê¸°ì— ì•„í‚¤í…ì²˜ ì§„í™” ë‹¤ì´ì–´ê·¸ë¨ ì‚½ì…

[3ì°¨ í”„ë¡œì íŠ¸ - ëª¨ë†€ë¦¬ì‹]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Single Application (app.py)     â”‚
â”‚ â”œâ”€ chatbot/                     â”‚
â”‚ â”œâ”€ llm/                         â”‚
â”‚ â”œâ”€ rag/                         â”‚
â”‚ â””â”€ preprocessing/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[4ì°¨ í”„ë¡œì íŠ¸ - ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ application/                    â”‚
â”‚ â”œâ”€ chatbot_server/              â”‚
â”‚ â”œâ”€ category_server/             â”‚
â”‚ â”œâ”€ clinic_server/               â”‚
â”‚ â”œâ”€ drug_server/                 â”‚
â”‚ â”œâ”€ emergency_support_server/    â”‚
â”‚ â””â”€ internal_external_server/    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ template/ (ê³µí†µ íŒ¨í„´)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì°¸ê³ ìë£Œ: C:\SKN12-3RD-5TEAM\ì‚°ì¶œë¬¼\5ì¡° ì‹œìŠ¤í…œ ì•„í‚¤í…ì³.pdf
```

**ğŸ“¸ [ì½”ë“œ ë¹„êµ ìœ„ì¹˜ F] - ì„¸ì…˜ ê´€ë¦¬ ì½”ë“œ ì§„í™”**
```
ì—¬ê¸°ì— ì½”ë“œ ë¹„êµ ìŠ¤í¬ë¦°ìƒ· ì‚½ì…
[ìƒë‹¨] 3ì°¨: InMemoryChatMessageHistory
[í•˜ë‹¨] 4ì°¨: Redis ë¶„ì‚° ì„¸ì…˜ ê´€ë¦¬
```

---

### 3. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë° ê¸°ìˆ  ìŠ¤íƒ

**3.1 ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜**

ë³¸ ì‹œìŠ¤í…œì€ **6ê°œì˜ ë…ë¦½ì ì¸ FastAPI ì„œë²„**ë¡œ êµ¬ì„±ëœ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì…ë‹ˆë‹¤:

| ì„œë¹„ìŠ¤ëª… | í¬íŠ¸ | ì£¼ìš” ê¸°ëŠ¥ | ì—”ë“œí¬ì¸íŠ¸ |
|---------|------|----------|------------|
| **Chatbot Server** | 8000 | ë©”ì¸ API ê²Œì´íŠ¸ì›¨ì´, ì‚¬ìš©ì ì¸ì¦, ì±„íŒ… | /account, /chatbot |
| **Category Server** | ë…ë¦½ í¬íŠ¸ | ì§ˆë¬¸ ë¶„ë¥˜ ë° ë„ë©”ì¸ ë¼ìš°íŒ… | /category |
| **Clinic Server** | ë…ë¦½ í¬íŠ¸ | ë³‘ì› ì •ë³´ ì„œë¹„ìŠ¤ | /clinic |
| **Drug Server** | ë…ë¦½ í¬íŠ¸ | ì˜ì•½í’ˆ ì •ë³´ ì„œë¹„ìŠ¤ | /drug |
| **Emergency Support Server** | ë…ë¦½ í¬íŠ¸ | ì‘ê¸‰ì˜ë£Œ ì§€ì› ì„œë¹„ìŠ¤ | /emergency-support |
| **Internal External Server** | ë…ë¦½ í¬íŠ¸ | ë‚´ì™¸ê³¼ ìƒë‹´ ì„œë¹„ìŠ¤ | /internal_external |

**3.2 í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ**

```yaml
Backend Framework: FastAPI 0.115.13
- ê³ ì„±ëŠ¥ ë¹„ë™ê¸° ì›¹ í”„ë ˆì„ì›Œí¬
- ìë™ API ë¬¸ì„œ ìƒì„± (Swagger/OpenAPI)
- Pydantic ê¸°ë°˜ ë°ì´í„° ê²€ì¦

LLM & AI:
- OpenAI: gpt-4o-mini (ë¹„ìš© ìµœì í™”ëœ LLM)
- LangChain: 0.3.66 (LLM ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜)
- FAISS: 1.11.0 (ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤)
- Sentence Transformers: 4.1.0 (í…ìŠ¤íŠ¸ ì„ë² ë”©)

Database Stack:
- MySQL: ê¸€ë¡œë²Œ DB ë° ìƒ¤ë“œ DB
- Firestore: NoSQL ë¬¸ì„œ ë°ì´í„°ë² ì´ìŠ¤
- Redis: ì„¸ì…˜ ê´€ë¦¬ ë° ìºì‹œ

Infrastructure:
- AWS EC2: ì„œë²„ í˜¸ìŠ¤íŒ…
- Nginx: ë¡œë“œë°¸ëŸ°ì„œ ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ
- uvicorn: ASGI ì›¹ì„œë²„
```

**ğŸ“Š [ë‹¤ì´ì–´ê·¸ë¨ ìœ„ì¹˜ G] - Component Diagram (ì»´í¬ë„ŒíŠ¸ ë‹¤ì´ì–´ê·¸ë¨)**
```
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: UML Component Diagram
ì—¬ê¸°ì— ì „ì²´ ì‹œìŠ¤í…œ ê¸°ìˆ  ìŠ¤íƒ ë ˆì´ì–´ ë‹¤ì´ì–´ê·¸ë¨ ì‚½ì…

ë ˆì´ì–´ êµ¬ì¡°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Layer: React 19.1.0        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API Gateway: Nginx + SSL/TLS        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service Layer: 6ê°œ FastAPI ì„œë²„      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data Layer: MySQL+Redis+Firestore   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AI Layer: OpenAI+LangChain+FAISS    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì»´í¬ë„ŒíŠ¸ ê°„ ì¸í„°í˜ì´ìŠ¤ ë° ì˜ì¡´ì„± í‘œì‹œ
```

**ğŸ“¸ [ìŠ¤í¬ë¦°ìƒ· ìœ„ì¹˜ H] - FastAPI Swagger ë¬¸ì„œ**
```
ì—¬ê¸°ì— 6ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ Swagger UI ìŠ¤í¬ë¦°ìƒ· ì‚½ì…
- Chatbot Server (:8000/docs)
- Category Server, Clinic Server, Drug Server ë“±
```

---

## ğŸ“‹ ìƒˆë¡œ ì´¬ì˜/ì œì‘ í•„ìš”í•œ ì‹œê°ë¬¼ ì²´í¬ë¦¬ìŠ¤íŠ¸

### **ğŸš€ ì²« 3ì¥ ì‹œê°ë¬¼ ìœ„ì¹˜ë³„ í•„ìš” ìë£Œ**

**[ìœ„ì¹˜ A] React UI ë©”ì¸ í™”ë©´**
- [ ] `cd frontend && npm start` ì‹¤í–‰ í›„ ë©”ì¸ í™”ë©´ ìº¡ì²˜

**[ìœ„ì¹˜ B] ì‹¤ì œ ì±—ë´‡ ëŒ€í™” í™”ë©´**
- [ ] ì§ˆë¬¸-ë‹µë³€ í”Œë¡œìš° ìŠ¤í¬ë¦°ìƒ· (ì˜ˆ: "ì‹¬ì¥ ìˆ˜ìˆ  í›„ ì£¼ì˜ì‚¬í•­")

**[ìœ„ì¹˜ C] í”„ë¡œì íŠ¸ ì„±ê³¼ ì§€í‘œ**
- [ ] ì„±ê³¼ ì§€í‘œ ì¸í¬ê·¸ë˜í”½ ì œì‘ (ì‘ë‹µì†ë„ 4.8ì´ˆ, 6ê°œ ë„ë©”ì¸ ë“±)

**[ìœ„ì¹˜ D] 3ì°¨ vs 4ì°¨ UI ë¹„êµ**
- [ ] 3ì°¨ Streamlit UI (`python C:\SKN12-3RD-5TEAM\app.py`)
- [ ] 4ì°¨ React UI ë‚˜ë€íˆ ë¹„êµ

**[ìœ„ì¹˜ E] ì•„í‚¤í…ì²˜ ì§„í™” ë‹¤ì´ì–´ê·¸ë¨**
- [ ] 3ì°¨ PDF ì°¸ê³ í•˜ì—¬ ì§„í™” ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±

**[ìœ„ì¹˜ F] ì„¸ì…˜ ê´€ë¦¬ ì½”ë“œ ë¹„êµ**
- [ ] InMemory vs Redis ì½”ë“œ ë¹„êµ ìŠ¤í¬ë¦°ìƒ·

**[ìœ„ì¹˜ G] Component Diagram**
- [ ] ì „ì²´ ì‹œìŠ¤í…œ ê¸°ìˆ  ìŠ¤íƒ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±

**[ìœ„ì¹˜ H] FastAPI Swagger ë¬¸ì„œ**
- [ ] 6ê°œ ì„œë²„ë³„ `/docs` í™”ë©´ ìº¡ì²˜

**[ìœ„ì¹˜ I] ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µì‹  ì•„í‚¤í…ì²˜**
- [ ] ì„œë¹„ìŠ¤ ê°„ í†µì‹  êµ¬ì¡° ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„± (User â†’ Frontend â†’ Nginx â†’ Services â†’ DB)

**[ìœ„ì¹˜ J] ë°ì´í„°ë² ì´ìŠ¤ ERD (Entity-Relationship Diagram)**
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ êµ¬ì¡° ERD ì‘ì„± (ê¸€ë¡œë²ŒDB, ìƒ¤ë“œDB, Redis, FAISS)

**3.3 ì•„í‚¤í…ì²˜ ì„¤ê³„ ì›ì¹™**

1. **ë…ë¦½ì„±**: ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ ê°œë°œ/ë°°í¬/í™•ì¥ ê°€ëŠ¥
2. **í™•ì¥ì„±**: Template Method Patternìœ¼ë¡œ ìƒˆë¡œìš´ ë„ë©”ì¸ ì¶”ê°€ ìš©ì´
3. **ì„±ëŠ¥**: ë¹„ë™ê¸° ì²˜ë¦¬ ë° Redis ìºì‹±ìœ¼ë¡œ ì‘ë‹µ ì†ë„ ìµœì í™” (í‰ê·  4.8ì´ˆ)
4. **ì•ˆì •ì„±**: ì„œë¹„ìŠ¤ë³„ ì¥ì•  ê²©ë¦¬ ë° ì˜ˆì™¸ ì²˜ë¦¬

---

### 4. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì„±

**4.1 ì„œë¹„ìŠ¤ ê°„ í†µì‹  êµ¬ì¡°**

**ğŸ“Š [ë‹¤ì´ì–´ê·¸ë¨ ìœ„ì¹˜ I] - Network Topology Diagram (ë„¤íŠ¸ì›Œí¬ í† í´ë¡œì§€)**
```
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: Network Topology Diagram ë˜ëŠ” Deployment Diagram
ì—¬ê¸°ì— ì„œë¹„ìŠ¤ ê°„ í†µì‹  êµ¬ì¡° ë‹¤ì´ì–´ê·¸ë¨ ì‚½ì…

êµ¬ì„± ìš”ì†Œ:
- User Layer: ì›¹ ë¸Œë¼ìš°ì € ì‚¬ìš©ì
- Frontend Layer: React SPA (í¬íŠ¸ 3000)
- Gateway Layer: Nginx ë¡œë“œë°¸ëŸ°ì„œ + SSL
- Service Layer: 6ê°œ FastAPI ì„œë²„ (ê°ê° ë…ë¦½ í¬íŠ¸)
  - Chatbot Server (8000)
  - Category, Clinic, Drug, Emergency, Internal/External
- Data Layer: MySQL, Redis, Firestore, FAISS

ì—°ê²°ì„ :
- HTTP/HTTPS ìš”ì²­ íë¦„
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
- ì„œë¹„ìŠ¤ ê°„ ë‚´ë¶€ í†µì‹ 
```

**4.2 ê° ì„œë¹„ìŠ¤ë³„ ìƒì„¸ ê¸°ëŠ¥**

**Category Server**
```python
# ì§ˆë¬¸ ë¶„ë¥˜ ë° ë„ë©”ì¸ ë¼ìš°íŒ… (Template Pattern ê¸°ë°˜)
POST /category/ask
{
    "question": "ì‹¬ì¥ ìˆ˜ìˆ  í›„ ì£¼ì˜ì‚¬í•­ì´ ë¬´ì—‡ì¸ê°€ìš”?"
}
# CategoryTemplateImpl í´ë˜ìŠ¤ë¡œ ì²˜ë¦¬
```

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #2] - Sequence Diagram (ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: Sequence Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: ì‚¬ìš©ì ì§ˆë¬¸ ì²˜ë¦¬ í”Œë¡œìš° ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
User â†’ Frontend â†’ Chatbot Server â†’ Category Server â†’ Specialized Server â†’ LLM â†’ Response
ê° ë‹¨ê³„ë³„ API í˜¸ì¶œê³¼ ë°ì´í„° íë¦„ì„ ì‹œê°í™”
```

**Chatbot Server (ë©”ì¸ ì„œë²„)**
```python
# ì‚¬ìš©ì ì¸ì¦ ë° ì±„íŒ… ê´€ë¦¬
POST /account/login, /signup, /logout  # AccountTemplateImpl
POST /chatbot/rooms, /message, /history  # ChatbotTemplateImpl
# UUID Access Token + MySQL ê¸€ë¡œë²Œ/ìƒ¤ë“œ DB + Redis ì„¸ì…˜ ê´€ë¦¬
```

**ì „ë¬¸ ë„ë©”ì¸ ì„œë²„ë“¤**
```python
# ê° ë„ë©”ì¸ë³„ íŠ¹í™”ëœ QA ì„œë¹„ìŠ¤ (RAG ì‹œìŠ¤í…œ ê¸°ë°˜)
POST /clinic/ask       # ClinicTemplateImpl
POST /drug/ask         # DrugTemplateImpl (ì‹¤ì œ Vector DB ì—°ë™)
POST /emergency-support/ask  # EmergencySupportTemplateImpl
POST /internal_external/ask  # InternalExternalTemplateImpl
```

---



---

## â…¡. ê¸°ìˆ  êµ¬í˜„ ë° ì•„í‚¤í…ì²˜

### 1. Template Method Pattern êµ¬í˜„

**1.1 ì„¤ê³„ íŒ¨í„´ ì ìš©**

í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜ë¥¼ ìœ„í•´ **Template Method Pattern**ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. 

**ì‹¤ì œ êµ¬í˜„ëœ BaseTemplate í´ë˜ìŠ¤:**
```python
# template/base/base_template.py
from abc import ABC, abstractmethod

class BaseTemplate(ABC):
    def init(self, config):
        """í…œí”Œë¦¿ë³„ ì´ˆê¸°í™”"""
        pass
    
    def on_load_data(self, config):
        """ë°ì´í„° ë¡œë”©(ì˜ˆ: csv, json, db ë“±)"""
        pass
    
    def on_client_create(self, db_client, client_session):
        """í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹œ ì½œë°±"""
        pass
    
    def on_client_update(self, db_client, client_session):
        """í´ë¼ì´ì–¸íŠ¸ ì—…ë°ì´íŠ¸ ì‹œ ì½œë°±"""
        pass
    
    def on_client_delete(self, db_client, user_id):
        """í´ë¼ì´ì–¸íŠ¸ ì‚­ì œ ì‹œ ì½œë°±"""
        pass
```

**ì‹¤ì œ êµ¬í˜„ëœ 7ê°œ í…œí”Œë¦¿:**
1. **AccountTemplateImpl** - ì‚¬ìš©ì ì¸ì¦ ë° ê³„ì • ê´€ë¦¬
2. **ChatbotTemplateImpl** - AI ì±—ë´‡ ëŒ€í™” ì²˜ë¦¬
3. **CategoryTemplateImpl** - ì˜ë£Œ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
4. **ClinicTemplateImpl** - ë³‘ì›/í´ë¦¬ë‹‰ ì •ë³´ ê´€ë¦¬
5. **DrugTemplateImpl** - ì•½ë¬¼ ì •ë³´ ì œê³µ
6. **EmergencySupportTemplateImpl** - ì‘ê¸‰ ì§€ì› ì„œë¹„ìŠ¤
7. **InternalExternalTemplateImpl** - ë‚´ê³¼/ì™¸ê³¼ ì „ë¬¸ ìƒë‹´

**ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ - ChatbotTemplateImpl:**
```python
# template/chatbot/chatbot_template_impl.py
class ChatbotTemplateImpl(ChatbotTemplate):
    def init(self, config):
        """ì±—ë´‡ í…œí”Œë¦¿ ì´ˆê¸°í™”"""
        print("Chatbot template initialized")
        # ì›¹ì„œë²„ì—ì„œëŠ” ì„ì‹œ ë©”ëª¨ë¦¬ ì €ì¥ ë¶ˆí•„ìš”
        # ëª¨ë“  ë°ì´í„°ëŠ” DB/Redisì— ì €ì¥
    
    def on_load_data(self, config):
        """ì±—ë´‡ ë°ì´í„° ë¡œë”©"""
        print("Chatbot data loaded")
    
    def on_client_create(self, db_client, client_session):
        """í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹œ ì½œë°±"""
        print("Chatbot client created")
```

**í…œí”Œë¦¿ ë“±ë¡ ë°©ì‹ (application/chatbot_server/main.py):**
```python
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í…œí”Œë¦¿ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
TemplateContext.add_template(TemplateType.ACCOUNT, AccountTemplateImpl())
TemplateContext.add_template(TemplateType.CHATBOT, ChatbotTemplateImpl())
```

ì´ íŒ¨í„´ì„ í†µí•´ ìƒˆë¡œìš´ ì˜ë£Œ ë„ë©”ì¸ ì¶”ê°€ ì‹œ BaseTemplateì„ ìƒì†ë°›ì•„ êµ¬í˜„í•˜ë©´ ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ ìë™ìœ¼ë¡œ í†µí•©ë©ë‹ˆë‹¤.

---

### 2. ê³ ê¸‰ ë²¡í„° ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„

**2.1 3ì°¨ í”„ë¡œì íŠ¸ì˜ ì •êµí•œ ìœ ì‚¬ë„ ê²€ìƒ‰ ì‹œìŠ¤í…œ**

3ì°¨ í”„ë¡œì íŠ¸ì—ì„œ êµ¬í˜„í•œ ê³ ê¸‰ ë²¡í„° ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ì„ 4ì°¨ í”„ë¡œì íŠ¸ì—ì„œ ê°œì„ í•˜ì—¬ ì ìš©í–ˆìŠµë‹ˆë‹¤:

**2.2 L2 ì •ê·œí™” ê¸°ë°˜ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°**

```python
# 3ì°¨ í”„ë¡œì íŠ¸ì—ì„œ êµ¬í˜„ëœ ì‹¤ì œ ì½”ë“œ (chatbot/chatbot_core.py)
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity

# ë²¡í„° ì •ê·œí™” í•¨ìˆ˜
def normalize(v):
    return v / (np.linalg.norm(v, axis=-1, keepdims=True) + 1e-8)

category_embeddings_norm = normalize(category_embeddings.numpy())

def run_chatbot_pipeline(user_input: str, session_id: str = "default") -> str:
    # 1. ì…ë ¥ ì„ë² ë”© + ì •ê·œí™”
    input_emb = embedder.encode([user_input])[0]  # (D,)
    input_emb_norm = input_emb / (np.linalg.norm(input_emb) + 1e-8)
    
    # 2. ì½”ì‚¬ì¸ ìœ ì‚¬ë„(0~1) top-k ê³„ì‚°
    sims = np.dot(category_embeddings_norm, input_emb_norm)  # (N,)
    top_k = 3
    top_idx = np.argsort(sims)[-top_k:][::-1]
    top_sims = sims[top_idx]
    max_sim = top_sims[0]
    
    # 3. ìœ ì‚¬ë„ ì„ê³„ê°’ ì²˜ë¦¬ (0.5 ë¯¸ë§Œì‹œ ì»¨í…ìŠ¤íŠ¸ ì—†ì´ ì‘ë‹µ)
    if max_sim < 0.5:
        return chatbot_response(user_input, "", session_id=session_id)
```

**2.3 2ë‹¨ê³„ ë²¡í„° ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸**

| ë‹¨ê³„ | ëª©ì  | ì„ê³„ê°’ | êµ¬í˜„ ë°©ì‹ |
|------|------|--------|----------|
| **1ë‹¨ê³„: ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜** | ì§ˆë¬¸ ë„ë©”ì¸ ê²°ì • | ìœ ì‚¬ë„ â‰¥ 0.5 | ì¹´í…Œê³ ë¦¬ë³„ ì„ë² ë”© DB ê²€ìƒ‰ |
| **2ë‹¨ê³„: ë¬¸ì„œ ê²€ìƒ‰** | ê´€ë ¨ ë¬¸ì„œ ì¶”ì¶œ | top-k=3, ìœ ì‚¬ë„ â‰¥ 0.5 | ë„ë©”ì¸ë³„ ì „ìš© ë²¡í„° DB ê²€ìƒ‰ |

```python
# 2ë‹¨ê³„ ê²€ìƒ‰ êµ¬í˜„
# 4. ì¹´í…Œê³ ë¦¬ë³„ ë²¡í„° DBì—ì„œ ë¬¸ì„œ ì¬ê²€ìƒ‰ (context ì¶”ì¶œ)
if predicted_category == "treatment":
    results = faiss_db.similarity_search(user_input, k=3)
    context = "\n\n".join([doc.page_content for doc in results])
else:
    index_file, chunks_file = config.VECTOR_DB_PATHS.get(predicted_category, config.VECTOR_DB_PATHS["default"])
    context_docs, context_index = load_vector_db_by_path(index_file, chunks_file)
    doc_emb = embedder.encode([user_input])[0]
    doc_emb_norm = doc_emb / (np.linalg.norm(doc_emb) + 1e-8)
    
    # ìœ ì‚¬ë„ 0.5 ì´ìƒë§Œ ì¶”ì¶œ (ìµœëŒ€ 3ê°œ)
    selected_idx = [i for i in np.argsort(sims2)[::-1] if sims2[i] >= 0.5][:3]
    
    if selected_idx:
        top_docs = [context_docs[i] for i in selected_idx]
        context = "\n".join(top_docs)
    else:
        context = ""   # ìœ ì‚¬í•œ ë¬¸ì„œê°€ ì—†ìœ¼ë©´ context ì—†ì´ ì²˜ë¦¬
```

**2.4 ë™ì  ì»¨í…ìŠ¤íŠ¸ ê²°ì • ë¡œì§**

- **ìœ ì‚¬ë„ < 0.5**: ê´€ë ¨ ë¬¸ì„œ ì—†ìŒìœ¼ë¡œ íŒë‹¨, ì¼ë°˜ ëŒ€í™”ë¡œ ì²˜ë¦¬
- **ìœ ì‚¬ë„ â‰¥ 0.5**: ê´€ë ¨ ë¬¸ì„œë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©í•˜ì—¬ ì „ë¬¸ì  ë‹µë³€ ìƒì„±
- **ë¹ˆ ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬**: ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ë„ ì‹œìŠ¤í…œì´ ì •ìƒ ë™ì‘í•˜ë„ë¡ ì„¤ê³„

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #14] - Activity Diagram (ì•¡í‹°ë¹„í‹° ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: Activity Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: 2ë‹¨ê³„ ë²¡í„° ê²€ìƒ‰ í”Œë¡œìš°
ì§ˆë¬¸ ì…ë ¥ â†’ ì„ë² ë”© â†’ 1ì°¨ ìœ ì‚¬ë„ ê²€ìƒ‰ â†’ ì„ê³„ê°’ íŒë‹¨ â†’ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ â†’ 2ì°¨ ê²€ìƒ‰ â†’ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± â†’ LLM ì²˜ë¦¬
ê° ë¶„ê¸°ì ì—ì„œì˜ ì¡°ê±´ë¬¸ê³¼ ë³‘ë ¬ ì²˜ë¦¬ ê³¼ì • í‘œí˜„
```

---

### 3. ì„ë² ë”© ëª¨ë¸ ë° ì „ì²˜ë¦¬ ì‹œìŠ¤í…œ

**3.1 ì˜ë£Œ ë°ì´í„° ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸**

3ì°¨ í”„ë¡œì íŠ¸ì—ì„œ êµ¬í˜„ëœ JSON ê¸°ë°˜ ì˜ë£Œ ë¬¸ì„œ ì „ì²˜ë¦¬ ì‹œìŠ¤í…œ:

```python
# preprocessing/preprocess.py - ì˜ë£Œ Q&A ë°ì´í„° ì „ì²˜ë¦¬
def load_question_text(json_path):
    with open(json_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
    return data.get("question", "").strip()

def load_answer_text(json_path):
    with open(json_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
    answer = data.get("answer", {})
    return answer.get("conclusion", "").strip()

def create_txt_from_all_subfolders(base_path, categories, sample_size=3):
    """ì¹´í…Œê³ ë¦¬ë³„ ì§ˆë¬¸-ë‹µë³€ ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬"""
    question_root = base_path / '1.ì§ˆë¬¸'
    answer_root = base_path / '2.ë‹µë³€'
    
    for category in categories:
        # ì¹´í…Œê³ ë¦¬ë³„ JSON íŒŒì¼ ìƒ˜í”Œë§
        q_files = get_json_files(q_folder)
        sampled_q = random.sample(q_files, sample_size)
        # ì§ˆë¬¸-ë‹µë³€ ìŒ ìƒì„± ë° í…ìŠ¤íŠ¸ ì¶”ì¶œ

# ì‹¤ì œ êµ¬í˜„ëœ í…ìŠ¤íŠ¸ ì •ì œ í•¨ìˆ˜ (preprocessing/preprocess.py)
def clean_text(raw_text: str) -> str:
    """ì˜ë£Œ ë¬¸ì„œ í…ìŠ¤íŠ¸ ì •ì œ"""
    # HTML íƒœê·¸ ì œê±°
    text = re.sub(r"<[^>]+>", "", raw_text)
    
    # ê·¸ë¦¼, í‘œ, ì¶œì²˜ ì •ë³´ ì œê±°
    text = re.sub(r"(ê·¸ë¦¼\s?\d+[\.:]?\s?.*?$|í‘œ\s?\d+[\.:]?\s?.*?$|ì¶œì²˜:.*?$)", 
                  "", text, flags=re.MULTILINE)
    
    # ê³µë°± ì •ê·œí™”
    text = re.sub(r"\s+", " ", text).strip()
    return text

# ë¬¸ì„œ ë¶„ë¥˜ ì²´ê³„ (ì‹¤ì œ êµ¬í˜„)
def load_and_process_json(filepath):
    filename = os.path.basename(filepath)
    if filename.startswith("13"):
        category = "êµê³¼ì„œ"
    elif filename.startswith("5"):
        category = "ë…¼ë¬¸"
    else:
        category = "ê¸°íƒ€"
    
    return Document(
        page_content=cleaned,
        metadata={
            "filename": filename,
            "c_id": data.get("c_id", ""),
            "type": category,
            "path": filepath
        }
    )
```

**3.2 ì„ë² ë”© ëª¨ë¸ ì•„í‚¤í…ì²˜**

3ì°¨ì™€ 4ì°¨ í”„ë¡œì íŠ¸ì—ì„œ í†µí•©ëœ ë“€ì–¼ ì„ë² ë”© ì‹œìŠ¤í…œ:

| êµ¬ë¶„ | ëª¨ë¸ | ìš©ë„ | íŠ¹ì§• |
|------|------|------|------|
| **ì£¼ ì„ë² ë”©** | jhgan/ko-sroberta-multitask | ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜, ìœ ì‚¬ë„ ê²€ìƒ‰ | í•œêµ­ì–´ ì˜ë£Œ í…ìŠ¤íŠ¸ íŠ¹í™” |
| **ë³´ì¡° ì„ë² ë”©** | sentence-transformers/all-MiniLM-L6-v2 | FAISS ë²¡í„°DB ì¸ë±ì‹± | ê²½ëŸ‰í™”, ë¹ ë¥¸ ì²˜ë¦¬ |

**3.3 ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë³„ íŠ¹í™” êµ¬í˜„**

4ì°¨ í”„ë¡œì íŠ¸ì˜ ë„ë©”ì¸ë³„ ìµœì í™”ëœ RAG íŒŒì´í”„ë¼ì¸:

```python
# 1. Drug Service - ì•½ë¬¼ ì •ë³´ íŠ¹í™”
class Vector_store:
    def __init__(self, embedding_model: str = "jhgan/ko-sroberta-multitask"):
        self.embedding_model = SentenceTransformer(embedding_model)
        self.prompt = PromptTemplate.from_template(
            "ë‹¹ì‹ ì€ í™˜ìë“¤ì—ê²Œ ì§ˆë³‘ ë° ì•½ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ëŠ” ì „ë¬¸ì ì¸ ì±—ë´‡ì…ë‹ˆë‹¤.\n"
            "ë‹¤ìŒ ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€ë‹µí•´ì£¼ì„¸ìš”:\n\n{context}\n\nì§ˆë¬¸: {question}"
        )

# 2. Emergency Support Service - ì‘ê¸‰ ìƒí™© íŠ¹í™”
def build_rag_chain(openai_api_key: str):
    prompt = PromptTemplate.from_template(
        "ë‹¹ì‹ ì€ ì˜í•™ì „ê³µì„ í•˜ì—¬ ì €í¬ì˜ ì§ˆë¬¸ì— ëŒ€ë‹µì„ ì˜ í•´ì£¼ëŠ” ì±—ë´‡ì…ë‹ˆë‹¤"
        "ë§Œì•½ ì§„ë£Œí˜¹ì€ ì•½, ì˜í•™ê³¼ ê´€ë ¨ì´ ì—†ëŠ” ì§ˆë¬¸ì´ë©´ ì§ˆë¬¸ì´ ì£¼ì œì™€ ë‹¤ë¥´ë‹¤ê³  í•˜ë©´ ë©ë‹ˆë‹¤"
    )
    return prompt | ChatOpenAI(model="gpt-4o-mini") | StrOutputParser()

# 3. Internal/External Service - ë‚´ê³¼/ì™¸ê³¼ ì „ë¬¸ ìƒë‹´
async def get_rag_answer_async(question, index, chunks, embed_model, rag_chain):
    # ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì‘ë‹µ ì†ë„ ìµœì í™”
    top_chunks = search_similar_chunks(question, index, chunks, embed_model)
    context = "\n".join(top_chunks)
    return await rag_chain.ainvoke({"context": context, "question": question})
```

**3.4 ë²¡í„° ê²€ìƒ‰ ìµœì í™”**

FAISS ì¸ë±ìŠ¤ë¥¼ í™œìš©í•œ ê³ ì† ìœ ì‚¬ë„ ê²€ìƒ‰:

```python
def search_similar_chunks(question: str, index, chunks, model, top_k=3):
    """FAISS ì¸ë±ìŠ¤ ê¸°ë°˜ ê³ ì† ê²€ìƒ‰"""
    embedding = model.encode([question])
    _, indices = index.search(np.array(embedding).astype("float32"), top_k)
    return [chunks[i] for i in indices[0]]

# ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê¸°ë°˜ ì •ë°€ ê²€ìƒ‰ (3ì°¨ í”„ë¡œì íŠ¸)
def normalize(v):
    return v / (np.linalg.norm(v, axis=-1, keepdims=True) + 1e-8)

category_embeddings_norm = normalize(category_embeddings.numpy())
sims = np.dot(category_embeddings_norm, input_emb_norm)  # ì½”ì‚¬ì¸ ìœ ì‚¬ë„
top_idx = np.argsort(sims)[-top_k:][::-1]  # ìƒìœ„ kê°œ ì¶”ì¶œ
```

**3.5 ë¬¸ì„œ ì²­í‚¹ ì „ëµ**

```python
# RecursiveCharacterTextSplitter í™œìš©
from langchain.text_splitter import RecursiveCharacterTextSplitter

text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,        # ì²­í¬ í¬ê¸°
    chunk_overlap=50,      # ì²­í¬ ê°„ ì¤‘ë³µ
    separators=["\n\n", "\n", ".", " ", ""]  # ë¶„ë¦¬ ìš°ì„ ìˆœìœ„
)

# ëŒ€ìš©ëŸ‰ ë¬¸ì„œ ì²˜ë¦¬
documents = text_splitter.split_documents(raw_documents)
```

**3.6 ë²¡í„° DB êµ¬ì¶• ê³¼ì •**

```python
# ì‹¤ì œ FAISS ì¸ë±ìŠ¤ êµ¬ì¶• (rag/vector_store.py)
from langchain.vectorstores import FAISS
import pickle
import json

def build_faiss_index(documents, output_path):
    """ë¬¸ì„œë“¤ë¡œë¶€í„° FAISS ë²¡í„° DB êµ¬ì¶•"""
    embeddings = []
    doc_ids = []
    categories = []
    
    for i, doc in enumerate(tqdm(documents, desc="Embedding documents")):
        embedding = embedding_model.embed_query(doc.page_content)
        embeddings.append(embedding)
        doc_ids.append(doc.metadata.get("c_id", f"doc_{i}"))
        categories.append(doc.metadata.get("type", "ê¸°íƒ€"))
    
    # FAISS ë²¡í„° ì €ì¥ì†Œ ìƒì„±
    vector_db = FAISS.from_texts(
        texts=[doc.page_content for doc in documents],
        embedding=embedding_model
    )
    
    # íŒŒì¼ ì €ì¥
    vector_db.save_local(faiss_dir)
    
    # ë©”íƒ€ë°ì´í„° ì €ì¥
    with open(os.path.join(output_path, "doc_embeddings.pkl"), "wb") as f:
        pickle.dump(embeddings, f)
    
    with open(os.path.join(output_path, "categories.json"), "w", encoding="utf-8") as f:
        json.dump(categories, f, ensure_ascii=False, indent=2)
```

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #15] - Data Flow Diagram (ë°ì´í„° í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: Data Flow Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: ë°ì´í„° ì „ì²˜ë¦¬ ë° ë²¡í„°í™” ê³¼ì •
ì›ë³¸ JSON â†’ í…ìŠ¤íŠ¸ ì •ì œ â†’ ì²­í‚¹ â†’ ì„ë² ë”© â†’ FAISS ì¸ë±ìŠ¤ â†’ ë©”íƒ€ë°ì´í„° ì €ì¥
ê° ë‹¨ê³„ë³„ ë°ì´í„° ë³€í™˜ê³¼ ì €ì¥ì†Œ ê´€ê³„ í‘œí˜„
```

---

### 4. LangChain ê³ ê¸‰ í™œìš© êµ¬í˜„

**4.1 RunnableWithMessageHistory êµ¬í˜„**

3ì°¨ í”„ë¡œì íŠ¸ì—ì„œ êµ¬í˜„í•œ ì„¸ì…˜ ê¸°ë°˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ì‹œìŠ¤í…œ:

```python
# 3ì°¨ í”„ë¡œì íŠ¸ íˆìŠ¤í† ë¦¬ ê´€ë¦¬ (llm/chatbot_llm.py)
from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder

# ì„¸ì…˜ë³„ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥ì†Œ
store = {}

def get_session_history(session_id: str):
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

# íˆìŠ¤í† ë¦¬ ê¸°ë°˜ ì±—ë´‡ ì²´ì¸
chatbot_with_history = RunnableWithMessageHistory(
    chatbot_chain,
    get_session_history,
    input_messages_key="question",   # ì…ë ¥ íŒŒë¼ë¯¸í„°ëª…
    history_messages_key="history"   # íˆìŠ¤í† ë¦¬ ë³€ìˆ˜ëª…
)

def chatbot_response(question: str, draft_answer: str, session_id: str = "default") -> str:
    return chatbot_with_history.invoke(
        {"question": question, "draft_answer": draft_answer},
        config={"configurable": {"session_id": session_id}}
    )
```

**4.2 MessagesPlaceholderì™€ ë™ì  í”„ë¡¬í”„íŠ¸**

```python
# ë™ì  í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ êµ¬í˜„
chatbot_prompt = ChatPromptTemplate.from_messages([
    ("system", """
    ë‹¹ì‹ ì€ ì˜ë£Œ ì§ˆë¬¸ì— ì „ë¬¸ì ìœ¼ë¡œ ë‹µí•˜ëŠ” AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. 
    ì‚¬ìš©ìì˜ ì§ˆë¬¸ê³¼ history, ì¹´í…Œê³ ë¦¬ ì „ìš© LLM ì‘ë‹µì„ ë°”íƒ•ìœ¼ë¡œ ìµœì ì˜ ë‹µë³€ì„ ìƒì„±í•˜ì„¸ìš”.
    """),
    MessagesPlaceholder(variable_name="history"),  # ë™ì  íˆìŠ¤í† ë¦¬ ì‚½ì…
    ("human", """[ì‚¬ìš©ì ì§ˆë¬¸]
{question}

[ì¹´í…Œê³ ë¦¬ ì „ìš© LLM ì‘ë‹µ]
{draft_answer}

[ìµœì¢… ì‘ë‹µ]""")
])
```

**4.3 Few-shot Learning êµ¬í˜„**

ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ì‹œ ìœ ì‚¬í•œ ì˜ˆì‹œë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ì—¬ LLM ì„±ëŠ¥ í–¥ìƒ:

```python
# ì‹¤ì œ Few-shot í”„ë¡¬í”„íŒ… êµ¬í˜„ (llm/category_classifier.py)
def classify_category_with_llm(input_text, retrieved_examples):
    """
    retrieved_examples: List of (text, category, score)
    """
    fewshot = ""
    for i, (ex, cat, score) in enumerate(retrieved_examples):
        fewshot += f"ì˜ˆì‹œ {i+1}:\ní…ìŠ¤íŠ¸: \"{ex}\"\nì¹´í…Œê³ ë¦¬: {cat}\n\n"

    prompt = f"""
ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸ë¥¼ ì•„ë˜ 6ê°€ì§€ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë¡œë§Œ ë¶„ë¥˜í•´ì•¼ í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì„ íƒ ê°€ëŠ¥í•œ ì¹´í…Œê³ ë¦¬:
- medicine
- treatment  
- assist_answer
- assist_question
- internal_answer
- internal_question

ì•„ë˜ëŠ” ë¶„ë¥˜ëœ ì˜ˆì‹œë“¤ì…ë‹ˆë‹¤:
{fewshot}

ì´ì œ ì…ë ¥ëœ í…ìŠ¤íŠ¸ë¥¼ ìœ„ ì¹´í…Œê³ ë¦¬ ì¤‘ **í•˜ë‚˜ë§Œ** ì„ íƒí•˜ì—¬ ë¶„ë¥˜í•˜ì„¸ìš”.

ì…ë ¥ í…ìŠ¤íŠ¸: "{input_text}"

ì •ë‹µ ì¹´í…Œê³ ë¦¬:"""
```

**4.4 RAG Chain êµ¬ì„±**

```python
# LangChain ì²´ì¸ êµ¬ì„± (llm/responder.py)
from langchain.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

def build_rag_chain(llm):
    prompt = ChatPromptTemplate.from_template("""
[ì „ë¬¸ LLM] ì•„ë˜ ì§ˆë¬¸ê³¼ context(ê´€ë ¨ ë¬¸ì„œ)ë¥¼ ì°¸ê³ í•˜ì—¬ ì „ë¬¸ì ì¸ ë‹µë³€ì„ ìƒì„±í•˜ë¼.
ì§ˆë¬¸: {question}
context: {context}
(ë¬¸ì„œ ë‚´ìš©ì´ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, ë…¼ë¦¬ì ì´ê³  ì¹œì ˆí•˜ê²Œ ë‹µë³€í•  ê²ƒ.)
""")
    chain = prompt | llm | StrOutputParser()
    return chain

# ì¹´í…Œê³ ë¦¬ë³„ ì „ë¬¸ LLM â†’ 1ì°¨ ë‹µë³€
category_llm = get_llm_by_category(predicted_category)
rag_chain = build_rag_chain(category_llm)
expert_response = rag_chain.invoke({"question": user_input, "context": context})

# ìµœì¢… ì±—ë´‡ LLM
final_answer = chatbot_response(user_input, expert_response, session_id=session_id)
```

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #16] - State Diagram (ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: State Diagram  
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: ì„¸ì…˜ ê´€ë¦¬ ì „í™˜ (InMemory â†’ Redis)
ì´ˆê¸°ìƒíƒœ â†’ ì„¸ì…˜ìƒì„± â†’ ë©”ëª¨ë¦¬ì €ì¥ â†’ Redisì „í™˜ â†’ ë¶„ì‚°ê´€ë¦¬ â†’ ì„¸ì…˜ë§Œë£Œ
ìƒíƒœ ì „í™˜ ì¡°ê±´ê³¼ ê° ìƒíƒœì—ì„œì˜ ì‘ì—… í‘œí˜„
```

---

### 5. ì¹´í…Œê³ ë¦¬ë³„ LLM ë¼ìš°íŒ… ì‹œìŠ¤í…œ

**5.1 ì˜ë£Œ ë„ë©”ì¸ë³„ ì „ë¬¸ LLM êµ¬ì„±**

3ì°¨ í”„ë¡œì íŠ¸ì—ì„œ êµ¬í˜„í•œ ì¹´í…Œê³ ë¦¬ë³„ LLM ë¼ìš°íŒ… ì‹œìŠ¤í…œ:

```python
# ì‹¤ì œ êµ¬í˜„ëœ LLM ë¼ìš°íŒ… (llm/router.py)
from langchain_openai import ChatOpenAI

# ì „ìš© LLM ì¸ìŠ¤í„´ìŠ¤ ì •ì˜ (ì¹´í…Œê³ ë¦¬ë³„)
llm_medicine = ChatOpenAI(model="gpt-4o-mini", temperature=0.2)
llm_treatment = ChatOpenAI(model="gpt-4o-mini", temperature=0.2)
llm_assist = ChatOpenAI(model="gpt-4o-mini", temperature=0.2)
llm_internal = ChatOpenAI(model="gpt-4o-mini", temperature=0.2)
llm_default = ChatOpenAI(model="gpt-4o-mini", temperature=0.2)

# ì¹´í…Œê³ ë¦¬ â†’ LLM ë§¤í•‘ ë”•ì…”ë„ˆë¦¬
target_llms = {
    "medicine": llm_medicine,
    "treatment": llm_treatment,
    "assist_answer": llm_assist,
    "assist_question": llm_assist,
    "internal_answer": llm_internal,
    "internal_question": llm_internal,
    "default": llm_default
}

def get_llm_by_category(category: str):
    """ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ LLM ì„ íƒ í•¨ìˆ˜"""
    return target_llms.get(category, llm_default)
```

**5.2 ì¹´í…Œê³ ë¦¬ë³„ ë²¡í„° DB ê²½ë¡œ ë§¤í•‘**

```python
# ì‹¤ì œ êµ¬í˜„ëœ ë²¡í„° DB ê²½ë¡œ ë§¤í•‘ (config.py)
VECTOR_DB_PATHS = {
    "medicine": (
         os.path.join(VECTOR_DB_PATH, "medicine/pilsu_pro_no_prepro_index1.faiss"),
         os.path.join(VECTOR_DB_PATH, "medicine/pilsu_pro_no_prepro_chunks1.txt"),
     ),
     "treatment": (
         os.path.join(VECTOR_DB_PATH, "treatment/RAG_Output/faiss_medical/faiss_index"),
         os.path.join(VECTOR_DB_PATH, "")
     ),
     "assist_answer": (
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part2_index1.index"),
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part2_chunks1.txt"),
     ),
     "assist_question": (
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part2_index1.index"),
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part2_chunks1.txt"),
     ),
     "internal_answer": (
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part1_index1.index"),
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part1_chunks1.txt"),
    ),
     "internal_question": (
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part1_index1.index"),
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part1_chunks1.txt"),
     ),
     "default": (
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part2_index1.index"),
         os.path.join(VECTOR_DB_PATH, "QA_random_pair_part2_chunks1.txt"),
     )
}
```

**5.3 ë™ì  ì»¨í…ìŠ¤íŠ¸ ë¡œë”©**

```python
# ì¹´í…Œê³ ë¦¬ë³„ ë²¡í„° DBì—ì„œ ë¬¸ì„œ ì¬ê²€ìƒ‰ (ì‹¤ì œ êµ¬í˜„)
if predicted_category == "treatment":
    # LangChain FAISS ì‚¬ìš©
    results = faiss_db.similarity_search(user_input, k=3)
    context = "\n\n".join([doc.page_content for doc in results])
else:
    # ì»¤ìŠ¤í…€ FAISS ì¸ë±ìŠ¤ ì‚¬ìš©
    index_file, chunks_file = config.VECTOR_DB_PATHS.get(
        predicted_category, config.VECTOR_DB_PATHS["default"]
    )
    context_docs, context_index = load_vector_db_by_path(index_file, chunks_file)
    
    # ì„ë² ë”© ë° ì •ê·œí™”
    doc_emb = embedder.encode([user_input])[0]
    doc_emb_norm = doc_emb / (np.linalg.norm(doc_emb) + 1e-8)
    
    # ë²¡í„° ì¬êµ¬ì„± ë° ìœ ì‚¬ë„ ê³„ì‚°
    context_docs_norm = np.array([
        c / (np.linalg.norm(c) + 1e-8) 
        for c in context_index.reconstruct_n(0, context_index.ntotal)
    ])
    sims2 = np.dot(context_docs_norm, doc_emb_norm)

    # ìœ ì‚¬ë„ 0.5 ì´ìƒë§Œ ì¶”ì¶œ (ìµœëŒ€ 3ê°œ)
    selected_idx = [i for i in np.argsort(sims2)[::-1] if sims2[i] >= 0.5][:3]
    
    if selected_idx:
        top_docs = [context_docs[i] for i in selected_idx]
        context = "\n".join(top_docs)
    else:
        context = ""   # ìœ ì‚¬í•œ ë¬¸ì¥ì´ ì—†ìœ¼ë©´ context ì—†ì´!
```

**5.4 ì „ë¬¸ LLM íŒŒì´í”„ë¼ì¸**

| ë‹¨ê³„ | ì²˜ë¦¬ ë‚´ìš© | ë‹´ë‹¹ ëª¨ë¸ |
|------|----------|----------|
| **1ë‹¨ê³„: ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜** | Few-shot í”„ë¡¬í”„íŒ…ìœ¼ë¡œ ë„ë©”ì¸ ë¶„ë¥˜ | GPT-4o-mini (ë¶„ë¥˜ìš©) |
| **2ë‹¨ê³„: ì „ë¬¸ê°€ ë‹µë³€** | ë„ë©”ì¸ë³„ ì»¨í…ìŠ¤íŠ¸ + RAG ì²´ì¸ | ì¹´í…Œê³ ë¦¬ë³„ ì „ìš© LLM |
| **3ë‹¨ê³„: ìµœì¢… ë‹µë³€** | íˆìŠ¤í† ë¦¬ + ì „ë¬¸ê°€ ë‹µë³€ ì¢…í•© | ì±—ë´‡ LLM |

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #17] - Component Diagram (ì»´í¬ë„ŒíŠ¸ ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: Component Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: LLM ë¼ìš°íŒ… ì•„í‚¤í…ì²˜
CategoryClassifier â†’ LLMRouter â†’ SpecializedLLM â†’ ChatbotLLM
ê° ì»´í¬ë„ŒíŠ¸ ê°„ì˜ ì¸í„°í˜ì´ìŠ¤ì™€ ì˜ì¡´ì„± ê´€ê³„ í‘œí˜„
```

---


**6.1 3ì°¨ í”„ë¡œì íŠ¸ Streamlit êµ¬í˜„**

3ì°¨ í”„ë¡œì íŠ¸ì—ì„œ êµ¬í˜„í•œ í’ë¶€í•œ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê¸°ëŠ¥ë“¤:

```python
# ì‹¤ì œ êµ¬í˜„ëœ Streamlit UI (app.py)
import streamlit as st
from chatbot.chatbot_core import run_chatbot_pipeline
from llm.chatbot_llm import chatbot_llm

# ê°€ìš´ë° ì •ë ¬ëœ ì œëª© (í° ê¸€ì”¨)
st.markdown("""
<h1 style='text-align: center;'>
    LangChain ë° RAG í™œìš©<br>
    ì˜ë£Œ LLM ê°œë°œ
</h1>
""", unsafe_allow_html=True)
st.markdown("<h1 style='text-align: center;'>MediChain</h1>", unsafe_allow_html=True)
```

**6.2 ì„¸ì…˜ ê´€ë¦¬ UI**

```python
# 1. ì„¸ì…˜ID ê´€ë¦¬
if 'session_id' not in st.session_state:
    st.session_state['session_id'] = "default"
if 'all_histories' not in st.session_state:
    st.session_state['all_histories'] = {}

session_id = st.text_input("ì„¸ì…˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”", st.session_state['session_id'])
if session_id != st.session_state['session_id']:
    st.session_state['session_id'] = session_id
    if session_id not in st.session_state['all_histories']:
        st.session_state['all_histories'][session_id] = []

chat_history = st.session_state['all_histories'].setdefault(session_id, [])
```

**6.3 ì‹¤ì‹œê°„ ëŒ€í™” ì¸í„°í˜ì´ìŠ¤**

```python
# ì‚¬ìš©ì ì…ë ¥ ë° ë‹µë³€ ìƒì„±
user_input = st.text_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:", key="input_box")
submit = st.button("ì§ˆë¬¸í•˜ê¸°")

if submit and user_input:
    with st.spinner("ë‹µë³€ ìƒì„± ì¤‘..."):  # ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
        answer = run_chatbot_pipeline(user_input, session_id=session_id)
        chat_history.append(("ì§ˆë¬¸", user_input))
        chat_history.append(("ì‘ë‹µ", answer))

# 2. íˆìŠ¤í† ë¦¬ ì¶œë ¥ (ìµœì‹ ì´ ì•„ë˜ìª½)
for role, text in chat_history:
    if role == "ì§ˆë¬¸":
        st.markdown(f"**ğŸ‘¤ ì§ˆë¬¸:** {text}")
    else:
        st.markdown(f"**ğŸ¤– ì‘ë‹µ:** {text}")
```

**6.4 ëŒ€í™” íˆìŠ¤í† ë¦¬ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥**

```python
# 3. íˆìŠ¤í† ë¦¬ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
if chat_history:
    history_str = ""
    for role, text in chat_history:
        history_str += f"[{role}]\n{text}\n\n"
    st.download_button(
        label="ğŸ’¾ ì´ ì„¸ì…˜ ëŒ€í™” ë‹¤ìš´ë¡œë“œ",
        data=history_str,
        file_name=f"chat_{session_id}.txt",
        mime="text/plain"
    )
```

**6.5 ìë™ ëŒ€í™” ìš”ì•½ ê¸°ëŠ¥**

```python
# 4. ì„¸ì…˜ ìš”ì•½ ê¸°ëŠ¥
def summarize_history(history):
    # ì§ˆë¬¸/ì‘ë‹µì„ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ì´ì–´ë¶™ì„
    convo = ""
    for role, text in history:
        if role == "ì§ˆë¬¸":
            convo += f"Q: {text}\n"
        else:
            convo += f"A: {text}\n"
    
    # LLMì—ê²Œ ìš”ì•½ ìš”ì²­ (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸)
    prompt = (
        "ë‹¤ìŒì€ ì˜ë£Œ ì±—ë´‡ê³¼ ì‚¬ìš©ìì˜ ëŒ€í™” ë‚´ì—­ì…ë‹ˆë‹¤.\n"
        "ì¤‘ìš”í•œ ì •ë³´, ë§¥ë½, ì‚¬ìš©ì ì§ˆë¬¸ ì˜ë„, ì±—ë´‡ì˜ ì£¼ìš” ë‹µë³€ì„ í•µì‹¬ ìœ„ì£¼ë¡œ 5ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”.\n\n"
        f"{convo}"
    )
    response = chatbot_llm.invoke(prompt)
    return response.content if hasattr(response, "content") else response

if chat_history and st.button("ğŸ“ ì´ ì„¸ì…˜ ëŒ€í™” ìš”ì•½"):
    with st.spinner("ìš”ì•½ ìƒì„± ì¤‘..."):
        summary = summarize_history(chat_history)
        st.markdown(f"#### ğŸ“„ ìš”ì•½\n{summary}")
```

**6.6 ì‚¬ìš©ì ê°€ì´ë“œ ë° ì•ˆë‚´**

```python
st.info("ì„¸ì…˜ IDë¥¼ ë°”ê¾¸ë©´ ë³„ë„ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì €ì¥ë˜ê³  ì „í™˜ë©ë‹ˆë‹¤.\n'ìš”ì•½' ë²„íŠ¼ìœ¼ë¡œ ëŒ€í™”ì˜ í•µì‹¬ ë‚´ìš©ì„ ë¹ ë¥´ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
```

**6.7 CLI ë²„ì „ ì§€ì›**

```python
# ì‹¤ì œ êµ¬í˜„ëœ CLI í…ŒìŠ¤íŠ¸ ë²„ì „ (test_chatbot.py)
def main():
    session_id = input("ì„¸ì…˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ") or "default"
    print(f"[INFO] ì„¸ì…˜ ID: {session_id} (exit ì…ë ¥ì‹œ ì¢…ë£Œ)\n")
    while True:
        user_input = input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì¢…ë£Œ: exit): ")
        if user_input.strip().lower() == "exit":
            break
        answer = run_chatbot_pipeline(user_input, session_id=session_id)
        print(f"\n[{session_id} ì‘ë‹µ]\n{answer}\n")
```

**6.8 UI/UX íŠ¹ì§•**

| ê¸°ëŠ¥ | êµ¬í˜„ ë°©ì‹ | ì‚¬ìš©ì ê²½í—˜ |
|------|----------|------------|
| **ë©€í‹° ì„¸ì…˜** | ì„¸ì…˜ ID í…ìŠ¤íŠ¸ë°•ìŠ¤ | ì—¬ëŸ¬ í™˜ì/ì£¼ì œë³„ ë…ë¦½ ìƒë‹´ |
| **ì‹¤ì‹œê°„ í”¼ë“œë°±** | `st.spinner()` ì‚¬ìš© | ë‹µë³€ ìƒì„± ì¤‘ ë¡œë”© í‘œì‹œ |
| **íˆìŠ¤í† ë¦¬ ê´€ë¦¬** | ì„¸ì…˜ë³„ ë©”ëª¨ë¦¬ ì €ì¥ | ëŒ€í™” ë§¥ë½ ìœ ì§€ |
| **ëŒ€í™” ìš”ì•½** | GPT ê¸°ë°˜ ìë™ ìš”ì•½ | 5ì¤„ ì´ë‚´ í•µì‹¬ ë‚´ìš© ì •ë¦¬ |
| **íŒŒì¼ ì €ì¥** | TXT ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ | ìƒë‹´ ë‚´ì—­ ë³´ê´€ |

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #18] - User Interface Diagram (UI ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: User Interface Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: Streamlit UI ë ˆì´ì•„ì›ƒ ë° ìƒí˜¸ì‘ìš©
ì œëª©ì˜ì—­ â†’ ì„¸ì…˜ì…ë ¥ â†’ ì§ˆë¬¸ì…ë ¥ â†’ ëŒ€í™”í‘œì‹œ â†’ ë‹¤ìš´ë¡œë“œ/ìš”ì•½ë²„íŠ¼
ì‚¬ìš©ì ì•¡ì…˜ê³¼ í™”ë©´ ì „í™˜ í”Œë¡œìš° í‘œí˜„
```

---

## â…¢. ì•„í‚¤í…ì²˜ ì„¤ê³„ ì² í•™ ë° ëª¨ë“ˆí™” ì „ëµ

### 1. 3ê³„ì¸µ ì•„í‚¤í…ì²˜ ì„¤ê³„ ëª©ì 

ë³¸ ì‹œìŠ¤í…œì€ **Template - Service - Application** 3ê³„ì¸µ êµ¬ì¡°ë¡œ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

| ê³„ì¸µ | ì—­í•  | êµ¬í˜„ ì˜ˆì‹œ |
|------|------|----------|
| **Application Layer** | HTTP ì—”ë“œí¬ì¸íŠ¸, ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬ | FastAPI ë¼ìš°í„°, ë¯¸ë“¤ì›¨ì–´ |
| **Service Layer** | ê³µí†µ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ì¸í”„ë¼ ì—°ë™ | DB ì—°ê²°, ìºì‹œ, ë©”ì‹œì§€ í |
| **Template Layer** | ë„ë©”ì¸ë³„ íŠ¹í™” ë¡œì§ | ì˜ë£Œ ë„ë©”ì¸ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ |

### 2. ì‹œìŠ¤í…œ êµ¬ì„±ë„

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #19] - Architecture Overview Diagram**
```
UML ëª…ì¹­: Package Diagram  
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”
Application Package â†’ Service Package â†’ Template Package
ê° íŒ¨í‚¤ì§€ë³„ ì£¼ìš” í´ë˜ìŠ¤ì™€ ì˜ì¡´ì„± ê´€ê³„ í‘œí˜„
```

---

## â…£. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 1. React ê¸°ë°˜ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #20] - React Component Hierarchy**
```
UML ëª…ì¹­: Class Diagram (React Components)
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: React ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°
App â†’ ChatRoom â†’ MessageList â†’ MessageItem
ê° ì»´í¬ë„ŒíŠ¸ì˜ propsì™€ state ê´€ê³„ í‘œí˜„
```

---

## â…¤. ë³„ì²¨ - í•µì‹¬ ì½”ë“œ êµ¬í˜„

### 6. í”„ë¡œì íŠ¸ ì§„í™” ë‹¤ì´ì–´ê·¸ë¨ ìœ„ì¹˜

**6.1 ìƒˆë¡œ ì¶”ê°€ëœ ë‹¤ì´ì–´ê·¸ë¨ ëª©ë¡**

| ë²ˆí˜¸ | UML ëª…ì¹­ | ë‚´ìš© | ìœ„ì¹˜ |
|------|----------|------|------|
| **#14** | Activity Diagram | 2ë‹¨ê³„ ë²¡í„° ê²€ìƒ‰ í”Œë¡œìš° | 2.4ì ˆ |
| **#15** | Data Flow Diagram | ë°ì´í„° ì „ì²˜ë¦¬ ë° ë²¡í„°í™” ê³¼ì • | 3.4ì ˆ |
| **#16** | State Diagram | ì„¸ì…˜ ê´€ë¦¬ ì „í™˜ (InMemory â†’ Redis) | 4.4ì ˆ |
| **#17** | Component Diagram | LLM ë¼ìš°íŒ… ì•„í‚¤í…ì²˜ | 5.4ì ˆ |
| **#18** | User Interface Diagram | Streamlit UI ë ˆì´ì•„ì›ƒ ë° ìƒí˜¸ì‘ìš© | 6.8ì ˆ |
| **#19** | Package Diagram | ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš” | â…¢.2ì ˆ |
| **#20** | Class Diagram | React ì»´í¬ë„ŒíŠ¸ êµ¬ì¡° | â…£.1ì ˆ |

**6.2 ê¸°ì¡´ ë‹¤ì´ì–´ê·¸ë¨ê³¼ì˜ í†µí•©**

ê¸°ì¡´ 13ê°œ ë‹¤ì´ì–´ê·¸ë¨ì— 7ê°œê°€ ì¶”ê°€ë˜ì–´ ì´ **20ê°œ ë‹¤ì´ì–´ê·¸ë¨**ìœ¼ë¡œ êµ¬ì„±:
- **ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**: #1~#7 (ê¸°ì¡´) + #19~#20 (ì‹ ê·œ)  
- **ê¸°ìˆ  êµ¬í˜„**: #8~#13 (ê¸°ì¡´) + #14~#18 (ì‹ ê·œ)

ì´ë¡œì¨ 3ì°¨ í”„ë¡œì íŠ¸ì˜ ëª¨ë†€ë¦¬ì‹ êµ¬í˜„ë¶€í„° 4ì°¨ í”„ë¡œì íŠ¸ì˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì§„í™”ê¹Œì§€ì˜ ì™„ì „í•œ ê¸°ìˆ ì  ì—¬ì •ì„ ë‹´ì€ í¬ê´„ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
```

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #5] - Class Diagram (í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: Class Diagram - Template Method Pattern
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: Template Method Pattern êµ¬ì¡° UML
- BaseTemplate (ì¶”ìƒ í´ë˜ìŠ¤)
- DrugTemplateImpl, ChatbotTemplateImpl ë“± êµ¬í˜„ì²´ë“¤
- ìƒì† ê´€ê³„ì™€ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ ê´€ê³„
- ê° Templateì˜ ì±…ì„ê³¼ ì˜ì¡´ì„± í‘œí˜„
```

**1.3 ë„ë©”ì¸ë³„ êµ¬í˜„ ì˜ˆì‹œ (ì‹¤ì œ êµ¬í˜„)**

```python
# template/drug/drug_template_impl.py - ì‹¤ì œ êµ¬í˜„ëœ ì˜ˆì‹œ
class DrugTemplateImpl(DrugTemplate):
    def __init__(self):
        super().__init__()
        print("Initializing Vector_store for DrugTemplate...")
        # Vector_store ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì €ì¥ (ì• í”Œë¦¬ì¼€ì´ì…˜ ë¼ì´í”„ì‚¬ì´í´ ë™ì•ˆ ì¬ì‚¬ìš©)
        self.vector_store = Vector_store(
            api_key=OPENAI_API_KEY,
            chunk_path=CHUNK_PATH,  # í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •ëœ ê²½ë¡œ
            index_path=INDEX_PATH,  # í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •ëœ ê²½ë¡œ
        )
        print("Vector_store for DrugTemplate initialized.")

    def init(self, config):
        """Drug template initializer (í”„ë ˆì„ì›Œí¬ í˜¸í™˜ì„±)"""
        print("Drug template init hook called.")
        
    def on_load_data(self, config):
        print("Drug data loaded")
        
    # í´ë¼ì´ì–¸íŠ¸ ë¼ì´í”„ì‚¬ì´í´ ë©”ì„œë“œë“¤...

    async def on_drug_ask_req(self, client_session, request: DrugAskRequest) -> DrugAskResponse:
        question = request.question
        # ë¯¸ë¦¬ ì´ˆê¸°í™”ëœ Vector_store ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©í•˜ì—¬ RAG ì‘ë‹µ ìƒì„±
        answer = await self.vector_store.rag_answer(question)
        return DrugAskResponse(answer=answer)
```

**1.4 í…œí”Œë¦¿ ë“±ë¡ ì‹œìŠ¤í…œ**

```python
# application/chatbot_server/main.py
@asynccontextmanager
async def lifespan(app: FastAPI):
    # ê° ë„ë©”ì¸ í…œí”Œë¦¿ ë“±ë¡
    TemplateContext.add_template(TemplateType.ACCOUNT, AccountTemplateImpl())
    TemplateContext.add_template(TemplateType.CHATBOT, ChatbotTemplateImpl())
    TemplateContext.add_template(TemplateType.CATEGORY, CategoryTemplateImpl())
    # ... ì¶”ê°€ í…œí”Œë¦¿ë“¤
    
    yield
```

---

### 2. LLM í†µí•© ì‹œìŠ¤í…œ êµ¬ì¡°

**2.1 LangChain ê¸°ë°˜ LLM íŒŒì´í”„ë¼ì¸ (ì‹¤ì œ êµ¬í˜„)**

```python
# service/lang_chain/drug_lang_chain.py - ì‹¤ì œ êµ¬í˜„ëœ RAG ì‹œìŠ¤í…œ
class Vector_store:
    """ë²¡í„° ì €ì¥ì†Œ í´ë˜ìŠ¤: FAISS ì¸ë±ìŠ¤ì™€ í…ìŠ¤íŠ¸ ì²­í¬ë¥¼ ì´ìš©í•œ RAG"""
    
    def __init__(
        self,
        api_key: str,
        chunk_path: str,
        index_path: str,
        embedding_model: str = "jhgan/ko-sroberta-multitask",
        chat_model: str = "gpt-4o-mini"
    ):
        self.chunks = self.load_chunks(chunk_path)  # í…ìŠ¤íŠ¸ ì²­í¬ ë¡œë“œ
        self.index = self.load_faiss_index(index_path)  # FAISS ì¸ë±ìŠ¤ ë¡œë“œ
        self.embedding_model = self.load_embedding_model(embedding_model)
        self.llm = self.connect_gpt(api_key, chat_model)  # OpenAI ì—°ê²°
        self.parser = StrOutputParser()
        self.rag_chain = self.build_rag_chain()  # RAG ì²´ì¸ êµ¬ì„±
        
    def build_rag_chain(self):
        """RAG(Retrieval-Augmented Generation) ì²´ì¸ êµ¬ì„±"""
        prompt = PromptTemplate.from_template(
            "ë‹¹ì‹ ì€ í™˜ìë“¤ì—ê²Œ ì§ˆë³‘ ë° ì•½ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ëŠ” ì „ë¬¸ì ì¸ ì±—ë´‡ì…ë‹ˆë‹¤.\n"
            "ë‹¤ìŒì€ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µí•˜ê¸° ìœ„í•œ ë¬¸ì„œì…ë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€ë‹µí•´ì£¼ì„¸ìš”:\n\n"
            "{context}\n\n"
            "---\n\n"
            "ì§ˆë¬¸: {question}\n"
            "ë‹µë³€:"
        )
        return prompt | self.llm | self.parser

    async def rag_answer(self, question: str, top_k: int = 3):
        """ì§ˆë¬¸ì— ëŒ€í•œ ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ì—¬ LLMìœ¼ë¡œ ì‘ë‹µ ìƒì„±"""
        embedding = self.embedding_model.encode([question])
        _, indices = self.index.search(np.array(embedding).astype("float32"), top_k)
        top_chunks = [self.chunks[i] for i in indices[0]]
        context = "\n".join(top_chunks)
        return await self.rag_chain.ainvoke({"context": context, "question": question})
```

**2.2 RAG (Retrieval-Augmented Generation) êµ¬í˜„ í˜„í™©**

**í˜„ì¬ êµ¬í˜„ëœ ë„ë©”ì¸:**
- **Drug Server**: ì™„ì „ êµ¬í˜„ (FAISS + jhgan/ko-sroberta-multitask)
- **Emergency Support Server**: ë¶€ë¶„ êµ¬í˜„ (Vector DB íŒŒì¼ í™•ì¸ë¨)

**êµ¬í˜„ êµ¬ì¡°:**
1. **Vector Database**: FAISS ì¸ë±ìŠ¤ íŒŒì¼ (.index)  
2. **Text Chunks**: ì „ì²˜ë¦¬ëœ í…ìŠ¤íŠ¸ ì²­í¬ íŒŒì¼ (.txt)
3. **Embedding Model**: jhgan/ko-sroberta-multitask (í•œêµ­ì–´ íŠ¹í™”)
4. **Generation**: gpt-4o-mini ëª¨ë¸ ì‚¬ìš© (top_k=3 ê²€ìƒ‰)

**2.3 ì‹¤ì œ êµ¬í˜„ëœ ìºì‹± ì‹œìŠ¤í…œ**

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #8] - Activity Diagram (í™œë™ ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: Activity Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: LLM RAG ì²˜ë¦¬ í”Œë¡œìš°
- ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥ â†’ í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬ â†’ ë²¡í„° ì„ë² ë”© 
- FAISS ìœ ì‚¬ë„ ê²€ìƒ‰ â†’ ìƒìœ„ Kê°œ ë¬¸ì„œ ì¶”ì¶œ â†’ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
- OpenAI API í˜¸ì¶œ â†’ ì‘ë‹µ ìƒì„± â†’ í›„ì²˜ë¦¬ â†’ ì‚¬ìš©ì ì‘ë‹µ
- ê° ë‹¨ê³„ë³„ ì˜ì‚¬ê²°ì • í¬ì¸íŠ¸ì™€ ì˜ˆì™¸ì²˜ë¦¬ íë¦„ í‘œí˜„
```

```python
# service/cache/async_session.py - ì‹¤ì œ Redis ìºì‹œ êµ¬í˜„
async def save_chat_history(user_id: str, room_id: str, message: dict):
    _check_init()
    key = f"chat_history:{user_id}:{room_id}"
    await r.rpush(key, json.dumps(message))
    await r.ltrim(key, -50, -1)  # ìµœê·¼ 50ê°œ ë©”ì‹œì§€ë§Œ ë³´ê´€

async def load_chat_history(user_id: str, room_id: str, limit: int = 20):
    _check_init()
    key = f"chat_history:{user_id}:{room_id}"
    history = await r.lrange(key, -limit, -1)
    return [json.loads(m) for m in history]

# ì„¸ì…˜ ê´€ë¦¬
async def set_session_info(access_token: str, session_info: SessionInfo):
    _check_init()
    await r.setex(f"accessToken:{access_token}", SESSION_EXPIRE_MINUTES*60, session_info.platform_id)
    await r.setex(f"sessionInfo:{access_token}", SESSION_EXPIRE_MINUTES*60, json.dumps(session_info.__dict__))
```

---

### 3. ë°ì´í„°ë² ì´ìŠ¤ ë° ìºì‹œ ì‹œìŠ¤í…œ

**3.1 ë©€í‹° ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…ì²˜ (ì‹¤ì œ êµ¬í˜„)**

```python
# service/db/database.py - ì‹¤ì œ MySQL í’€ êµ¬í˜„
class MySQLPool:
    def __init__(self):
        self.pool = None

    async def init(self, host, port, user, password, db, minsize=5, maxsize=20):
        self.pool = await aiomysql.create_pool(
            host=host, port=port, user=user, password=password, db=db,
            minsize=minsize, maxsize=maxsize, autocommit=True
        )

    async def call_procedure(self, proc_name: str, params: tuple = ()): 
        if self.pool is None:
            raise RuntimeError("MySQLPool is not initialized. Call init() first.")
        async with self.pool.acquire() as conn:
            async with conn.cursor(aiomysql.DictCursor) as cur:
                await cur.callproc(proc_name, params)
                result = await cur.fetchall()
                await cur.close()
                return result

    async def execute(self, query: str, params: tuple = ()): 
        if self.pool is None:
            raise RuntimeError("MySQLPool is not initialized. Call init() first.")
        async with self.pool.acquire() as conn:
            async with conn.cursor(aiomysql.DictCursor) as cur:
                await cur.execute(query, params)
                if query.strip().lower().startswith("select"):
                    return await cur.fetchall()
                return cur.lastrowid
```

**3.2 Redis ìºì‹œ ì‹œìŠ¤í…œ**

**ğŸ”¥ [ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€ ìœ„ì¹˜ #9] - State Machine Diagram (ìƒíƒœ ê¸°ê³„ ë‹¤ì´ì–´ê·¸ë¨)**
```
UML ëª…ì¹­: State Machine Diagram
ê¶Œì¥ ë‹¤ì´ì–´ê·¸ë¨: ì‚¬ìš©ì ì„¸ì…˜ ë° ì±„íŒ… ìƒíƒœ ê´€ë¦¬
- ì‚¬ìš©ì ë¡œê·¸ì¸ â†’ ì„¸ì…˜ ìƒì„± â†’ ì±„íŒ…ë°© ì…ì¥ â†’ ëŒ€í™” ì¤‘ â†’ ì„¸ì…˜ ë§Œë£Œ/ë¡œê·¸ì•„ì›ƒ
- ClientSessionState: NONE â†’ CHATTING â†’ WAITING â†’ NONE
- ê° ìƒíƒœ ì „í™˜ ì¡°ê±´ê³¼ ì•¡ì…˜ í‘œí˜„
- Redis TTL ê¸°ë°˜ ì„¸ì…˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬
```

```python
# service/cache/redis_client.py
class RedisCache:
    def __init__(self, config: CacheConfig):
        self.redis = redis.asyncio.Redis(
            host=config.host,
            port=config.port,
            decode_responses=True
        )
        self.session_expire_time = config.session_expire_time  # 3600ì´ˆ
        
    async def store_conversation_context(self, user_id: str, context: dict):
        key = f"conversation:{user_id}"
        await self.redis.setex(key, self.session_expire_time, json.dumps(context))
        
    async def get_conversation_context(self, user_id: str) -> dict:
        key = f"conversation:{user_id}"
        data = await self.redis.get(key)
        return json.loads(data) if data else {}
```

**ğŸ“Š [ë‹¤ì´ì–´ê·¸ë¨ ìœ„ì¹˜ J] - Entity-Relationship Diagram (ERD)**
```mermaid
erDiagram
    %% Global Database (medichain_global)
    users {
        int user_id PK "AUTO_INCREMENT"
        varchar username UK "ë¡œê·¸ì¸ ID"
        varchar email "ì´ë©”ì¼"
        varchar password_hash "SHA256 í•´ì‹œ"
        varchar salt "16ë°”ì´íŠ¸ hex salt"
        timestamp created_at
        timestamp updated_at
        boolean is_active
    }
    
    shard_info {
        int shard_id PK
        varchar host "DB í˜¸ìŠ¤íŠ¸"
        int port "3306"
        varchar database_name "ìƒ¤ë“œ DBëª…"
        varchar username "DB ì‚¬ìš©ìëª…"
        varchar password "DB íŒ¨ìŠ¤ì›Œë“œ"
        boolean is_active
        int max_connections "20"
    }
    
    user_shard_mapping {
        int user_id PK,FK
        int shard_id FK
        timestamp created_at
    }
    
    %% Shard Database (medichain_shard_0, medichain_shard_1)
    chat_room {
        int chat_id PK "AUTO_INCREMENT"
        int user_id FK "ê¸€ë¡œë²Œ DB user_id"
        varchar title "ì±„íŒ…ë°© ì œëª©"
        varchar domain "clinic/drug/emergency"
        timestamp created_at
        timestamp updated_at
        boolean is_active
    }
    
    chat_messages {
        int message_id PK "AUTO_INCREMENT"
        int chat_id FK
        int user_id FK
        enum role "user/bot"
        text content "ë©”ì‹œì§€ ë‚´ìš©"
        varchar message_type "text"
        timestamp created_at
    }
    
    user_chat_stats {
        int user_id PK
        int total_rooms
        int total_messages
        timestamp last_activity
    }
    
    %% Relationships
    users ||--o| user_shard_mapping : "has"
    shard_info ||--o{ user_shard_mapping : "contains"
    users ||--o{ chat_room : "creates"
    chat_room ||--o{ chat_messages : "contains"
    users ||--o| user_chat_stats : "has"
```

**ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì„¤ëª…:**
```
[Global DB - medichain_global]
â”œâ”€ users: ì‚¬ìš©ì ì¸ì¦ ì •ë³´ (RegisterUser í”„ë¡œì‹œì €ë¡œ ìƒì„±)
â”œâ”€ shard_info: ìƒ¤ë“œ DB ì—°ê²° ì •ë³´ (2ê°œ ìƒ¤ë“œ)
â””â”€ user_shard_mapping: ì‚¬ìš©ìë³„ ìƒ¤ë“œ í• ë‹¹ (user_id % shard_count)

[Shard DB - medichain_shard_0/1]
â”œâ”€ chat_room: ì‚¬ìš©ìë³„ ì±„íŒ…ë°© (GetChatRoomsByUser í”„ë¡œì‹œì €)
â”œâ”€ chat_messages: ëŒ€í™” ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬
â””â”€ user_chat_stats: ì‚¬ìš©ì ëŒ€í™” í†µê³„

[Redis Cache]
â”œâ”€ accessToken:{uuid} â†’ platform_id (TTL: 3600ì´ˆ)
â”œâ”€ sessionInfo:{uuid} â†’ SessionInfo JSON (TTL: 3600ì´ˆ)
â”œâ”€ chat_history:{user_id}:{room_id} â†’ ìµœê·¼ 50ê°œ ë©”ì‹œì§€
â””â”€ conversation:{user_id} â†’ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ (TTL: 3600ì´ˆ)

[FAISS Vector DB]
â””â”€ ì˜ë£Œ ë¬¸ì„œ ì„ë² ë”© ë²¡í„° (6ê°œ ë„ë©”ì¸ë³„ ë¶„ë¦¬)
```

**3.3 ë°ì´í„° íë¦„ë„**

```
ì‚¬ìš©ì ìš”ì²­ â†’ Access Token í™•ì¸ â†’ Redis ì„¸ì…˜ ê²€ì¦ â†’ 
ê¸€ë¡œë²Œ DB (ì‚¬ìš©ì ì •ë³´) â†’ ìƒ¤ë“œ DB (ëŒ€í™” íˆìŠ¤í† ë¦¬) â†’ 
Vector DB (ì˜ë£Œ ë¬¸ì„œ ê²€ìƒ‰) â†’ LLM ì²˜ë¦¬ â†’ ì‘ë‹µ ìºì‹± â†’ ì‚¬ìš©ì
```

---

